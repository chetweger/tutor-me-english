define(["modules/util/util.instances","modules/util/util.model","jq!starfield/jquery.mod"],function(a,b,c){function k(a,e){this.$element=a,this.$slider=c("."+d+"-slider",this.$element),this.model=new b(e),this.mode=this.model.get("mode"),this.source=this.model.get("source")||"default",this.loaded=this.subscriptions=[],this.timer=this.animating=this.paginationType=this.arrowsType=!1,this.$pagination=this.$paginationArrows=this.$arrows=this.$layout=this.$overlay=!1,this.preloadAmount=3,this.isInitializing=!0,this.init()}var d="wsb-media-gallery",e={None:!1,Default:"pagination",Thumbnail:"pagination-thumbs"},f={None:!1,Default:"bordered"},g={None:!1,Default:"arrows",Hover:"arrows-hover"},h=[{pagination:e.None,border:f.Default,arrows:g.Default},{pagination:e.Default,border:f.None,arrows:g.None},{pagination:e.Default,border:f.Default,arrows:g.Default},{pagination:e.Default,border:f.None,arrows:g.Default},{pagination:e.Thumbnail,border:f.None,arrows:g.Hover}],i={pagination:e.Default,border:f.Default,arrows:g.Default},j=function(a){return a<h.length?h[a]:i};k.prototype={init:function(){var a=this;if(this.model.isKO){var b=function(){a.refresh(),a.isInitializing&&(a.isInitializing=!1)};this.subscriptions.push(this.model.get("localizedAssets",!0).subscribe(function(){a.isInitializing=!0,b()}));var c=this.model.get("mutatorViewModel",!0);if(c)for(var d in c)this.model.ko.isObservable(c[d])&&this.subscriptions.push(c[d].subscribe(b))}this.refresh()},"goto":function(a,b){if(!this.animating&&this.assets[a]){var f=this;this.animating=!0,clearTimeout(this.timer),this.preloadFrom(a);var g=0,h=this.model.get("GalleryTransition"),i=this.$cur||!1;i&&(g=c("li",this.$slider).index(i));var k=c("li:eq("+a+")",this.$slider),l=!1;this.$cur?g===a&&(h="None"):(this.$cur=i=c("li:eq("+a+")",this.$slider),this.zindex=this.model.get("Layer"),l=!0,b="next");var m=this.zindex;b||(b=a>=g?"next":"prev");var n=function(){f.$cur=k,f.animating=!1;if(f.model.get("GalleryAutoStart")||!l&&f.source!=="homefinder"){var b=a+1,c=f.assets.length,d;b>=c&&(b=0,d="next"),f.timer=setTimeout(function(){f.goto(b,d)},(parseFloat(f.model.get("GallerySpeed"))||1)*1e3)}};j(f.model.get("GalleryTheme")).pagination!==e.None&&f.$pagination&&f.$pagination.length&&f.$pagination.trigger("paginate."+d,a);switch(h){case"FirstTime":k.css("left",0).fadeIn("slow",function(){n()});break;case"None":k.css({left:0,"z-index":m+1}).show(),!l&&g!==a&&i.css("z-index",m).hide(),n();break;case"Fade":k.css({left:0,"z-index":m+1}).hide().fadeIn("slow",function(){n()}),l||i.fadeOut("slow");break;case"Slide":var o=i.width();l?k.css({left:b==="prev"?-o:o,"z-index":m+1}).show().animate({left:0},500,function(){n()}):(i.css("z-index",m),k.css({left:b==="prev"?-o:o,"z-index":m+1}).show().animate({left:0},{duration:500,queue:!1}),i.animate({left:b==="prev"?o:-o},500,function(){i.hide(),n()}));break;case"Slide Vertically":var p=i.height();l?k.css({top:b==="prev"?-p:p,left:0,"z-index":m+1}).show().animate({top:0},500,function(){n()}):(i.css("z-index",m),k.css({top:b==="prev"?-p:p,left:0,"z-index":m+1}).show().animate({top:0},{duration:500,queue:!1}),i.animate({top:b==="prev"?p:-p},500,function(){i.hide(),n()}));break;case"Stack":var o=i.width();l?k.css({left:b==="prev"?-o:o,"z-index":m+1}).show().animate({left:0},500,function(){n()}):(i.css("z-index",m),k.css({left:b==="prev"?-o:o,"z-index":m+1}).show().animate({left:0},{duration:500,queue:!1}),i.fadeOut(500,function(){n()}));break;case"Stack Vertically":var p=i.height();l?k.css({top:b==="prev"?-p:p,left:0,"z-index":m+1}).show().animate({top:0},500,function(){n()}):(i.css("z-index",m),k.css({top:b==="prev"?-p:p,left:0,"z-index":m+1}).show().animate({top:0},{duration:500,queue:!1}),i.fadeOut(500,function(){n()}))}}},refresh:function(){var a=this,b=this.assets=this.model.get("localizedAssets")||this.model.get("GalleryAssets"),h=this.model.get("GalleryTheme"),i=j(h),k=this.model.get("effects"),l=k?k[parseInt(h)]:!1,m=l&&l.className?l.className:!1;this.model.isKO&&!a.isInitializing&&this.model.set("className",m),this.loaded=[],this.animating=!0,clearTimeout(this.timer);var n=this.width=parseInt(this.model.get("Width").replace("px","")),o=this.model.get("Height");if(this.mode=="mobile"){var p=this.$element.width(),q=p/n;q!=1&&(n=this.width=p,o=parseInt(o.replace("px",""))*q)}this.$element.css({height:o,width:n}),this.arrowsType=i.arrows,this.arrowsType===g.Default?(this.arrowsRefresh(),n=this.width=n-44,this.$slider.css("margin-left",22)):this.arrowsType===g.Hover?(this.arrowsRefresh(),this.$slider.css("margin-left",0)):(this.arrowsRemove(),this.$slider.css("margin-left",0)),i.border===f.Default?(this.$slider.addClass(f.Default),n=this.width=n-30):this.$slider.removeClass(f.Default),this.$cur=!1,this.$slider.empty().css("width",n);for(var r=0;r<b.length;r++)this.$slider.append(c('<li class="loading"/>').css({width:this.width,left:this.width})),this.loaded[r]=!1;this.paginationType=i.pagination,this.paginationType!==e.None?(this.paginationRefresh(),this.$slider.css("height",this.$element.height()-this.$pagination.outerHeight(!0))):(this.paginationRemove(),this.$slider.css("height",this.$element.height())),i.border===f.Default&&this.$slider.css("height",this.$slider.height()-30),this.arrowsType===g.Default?this.$arrows.css("top",(this.$slider.outerHeight(!0)-44)/2):this.arrowsType===g.Hover&&this.$arrows.height(this.$slider.outerHeight(!0)).css("z-index",this.model.get("Layer")+2);if(this.mode=="designer"){var s=this.zindex||this.model.get("Layer");if(!this.$overlay||!this.$overlay.length)this.$overlay=c("<div/>").addClass(d+"-overlay").appendTo(this.$element);this.$overlay.css({position:"absolute",top:0,width:this.$element.outerWidth(),height:this.$element.outerHeight(),"z-index":s+2}).children().remove()}this.load(0,function(){a.animating=!1,a.goto(0)})},getAutofitCSS:function(a,b){var c=a.width(),d=a.height(),e=d/c,f=b.width(),g=b.height(),h=g/f,i,j=0,k=0,l=0;return e<1?h<1&&e>h?j=f:i=g:e>1?h>1&&e<h?i=g:j=f:h<1?j=f:i=g,i?k=-(c*(i/d)-f)/2:l=-(d*(j/c)-g)/2,{width:j||"auto",height:i||"auto",left:k,top:l}},load:function(a,b){var f=this,g=this.assets[a];if(g&&!this.loaded[a]){this.loaded[a]=!0;var h=c("li:eq("+a+")",this.$slider);switch(g.type){case"video":break;case"image":default:var i=!1,j=!1,k=c("<img/>").bind("load",function(){var l=h.removeClass("loading");g.link&&(l=c("<a/>").attr({href:g.link,title:g.caption}).appendTo(h),Boolean(g.link.match(/^((http|https|ftp|mailto):|\/\/)/i))&&l.attr("target","_blank")),k.appendTo(l);if(f.model.get("GalleryAutoSize"))k.css(f.getAutofitCSS(k.addClass("autosize"),h));else{var m=Math.floor((h.height()-k.height())/2);m>0&&k.css("marginTop",m)}i&&j&&(j.addClass("autosize").appendTo(c("<div/>").addClass(d+"-"+e.Thumbnail+"-thumbnail-wrapper").appendTo(i.removeClass("loading"))),j.css(f.getAutofitCSS(j,i))),f.model.get("GalleryCaption")&&g.caption&&l.append(c("<div/>").addClass(d+"-caption").css("width",f.width).text(g.caption)),c.isFunction(b)&&b(a),k.unbind("load")}),l=g.src||"/document/"+g.id;k[0].src=l,f.paginationType&&f.paginationType==e.Thumbnail&&f.$pagination&&(i=c("li:eq("+a+")",f.$pagination),j=c("<img/>"),j[0].src=l)}}else c.isFunction(b)&&b(!1)},preloadFrom:function(a){var b=this.assets.length;for(var c=a;c<a+this.preloadAmount;c++){var d=c;c>b&&(d=0+(b-c)),this.load(d)}for(var c=a;c>a-this.preloadAmount;c--){var d=c;c<0&&(d=b+c),this.load(d)}},paginationRefresh:function(){var a=this;this.paginationRemove(),this.$pagination=c("<ul/>").addClass(d+"-"+this.paginationType).appendTo(this.$element);if(this.paginationType===e.Thumbnail){var b=this.$pagination.wrap(c("<div/>").addClass(d+"-"+e.Thumbnail+"-wrapper")).parent(),f=c("<div/>").addClass(d+"-"+e.Thumbnail+"-left-arrow"),g=c("<div/>").addClass(d+"-"+e.Thumbnail+"-right-arrow");this.$paginationArrows=f.insertBefore(b).add(g.insertAfter(b));var h=b.width(),i=93,j=2,k=5,l=Math.floor(h/(i+j*2)),m=Math.min(Math.floor((h/l-i)/2),k),n=Math.ceil(l/2);this.preloadAmount=l;var o=this.assets.length;for(var p=0;p<o;p++)this.paginationThumbCreate(p,m);var q=c("li:first",this.$pagination).outerWidth(!0),r=h-q*l;b.width(h-=r).css("left",(parseInt(b.css("left").replace("px",""))||0)+Math.floor(r/2)),this.$pagination.width((i+k*2)*o),o>1&&g.addClass("enabled"),this.$paginationArrows.bind("click",function(){var b=c(this);if(!a.animating&&b.hasClass("enabled")){var d,e=a.$cur?c("li",a.$slider).index(a.$cur):0;b.attr("class")==f.attr("class")?(d="prev",e--):(d="next",e++),e<1?e=0:e>=o-1&&(e=o-1),a.goto(e,d)}}),this.$pagination.bind("paginate."+d,function(b,d){c("li",a.$pagination).removeClass("active"),c("li:eq("+d+")",a.$pagination).addClass("active"),d<1?(f.removeClass("enabled"),o>1&&g.addClass("enabled")):d>=o-1?(g.removeClass("enabled"),o>1&&f.addClass("enabled")):(f.addClass("enabled"),g.addClass("enabled")),a.$pagination.animate({left:d>=n?-(q*(d+1-n)):0},500,function(){a.animating=!1})})}else{for(var p=0;p<this.assets.length;p++)this.paginationCreate(p);this.$pagination.bind("paginate."+d,function(b,d){c("li",a.$pagination).removeClass("active"),c("li:eq("+d+")",a.$pagination).addClass("active")})}},paginationCreate:function(a){var b=this;this.$pagination.append(c("<li/>").bind("click",function(){b.animating||b.goto(a)}))},paginationThumbCreate:function(a,b){var d=this;this.$pagination.append(c("<li/>").css({marginLeft:b,marginRight:b}).bind("click",function(){d.animating||d.goto(a)}))},paginationRemove:function(){this.$pagination&&this.$pagination.length&&(this.$pagination.children("li").unbind().remove(),this.$pagination.remove(),this.$paginationArrows&&this.$paginationArrows.length&&(this.$paginationArrows.unbind().remove(),this.$paginationArrows=!1),this.$pagination=!1)},arrowsRefresh:function(){this.arrowsRemove();var a=this,b=c("<div/>").addClass(d+"-"+this.arrowsType+"-left-arrow"),e=c("<div/>").addClass(d+"-"+this.arrowsType+"-right-arrow");this.$arrows=b.insertBefore(this.$slider).add(e.insertAfter(this.$slider)),this.$arrows.bind("click",function(){if(!a.animating){var d=c(this),e=a.$cur?c("li",a.$slider).index(a.$cur):0,f=a.assets.length,g;d.attr("class")==b.attr("class")?(g="prev",e--):(g="next",e++),e<0?e=f-1:e>=f&&(e=0),a.goto(e,g)}}),this.arrowsType===g.Hover&&this.$arrows.css("opacity",0).bind("mouseenter",function(){c(this).stop().fadeTo(100,1)}).bind("mouseleave",function(){c(this).stop().fadeTo(100,0)})},arrowsRemove:function(){this.$arrows&&this.$arrows.length&&(this.$arrows.unbind().remove(),this.$arrows=!1)},destroy:function(){for(var a in this.subscriptions)this.subscriptions[a].dispose();clearTimeout(this.timer),this.paginationRemove(),this.arrowsRemove(),l.destroy(this.$element),this.$element.remove()}};var l=new a(d,k);return{render:function(a,b){var c=l.get(a);return c?c.refresh():c=l.create(a,b),c},destroy:function(a){var b=l.get(a);return b?(l.destroy(a),!0):!1}}})