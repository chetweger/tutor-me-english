define(["jq!starfield/jquery.mod","libs/knockout/knockout","libs/jquery/jqui","starfield/sf.dialog"],function(a,b){a.fn.wsbDialog=function(){if(arguments.length){var b=arguments[0];if(typeof b=="object"){if(b.buttons)for(var c=0;c<b.buttons.length;c++){var d=b.buttons[c];d.cancel||(d.enabledClasses||(d.enabledClasses="btn btn-success"),d.disabledClasses||(d.disabledClasses="btn btn-success disabled"))}var e=b.onOpen;b.onOpen=function(c){c.find(".sf-icn").removeClass("sf-icn").addClass("wsb-x"),b.id&&c.attr("id",b.id),setTimeout(function(){c.click().focus();var a=c.find("input:visible,textarea:visible");a.length>0&&a.first().focus()},1),a(document).bind("keydown.dialog",function(a){if(a.which===8){var b=a.srcElement||a.target,c=b.tagName.toUpperCase(),d=b.type&&b.type.toUpperCase();return c==="INPUT"&&(d==="TEXT"||d==="PASSWORD"||d==="URL")||c==="TEXTAREA"||b.getAttribute("contenteditable")||b.getAttribute("id")==="themeCssAceEditor"}});var d=window.$sf.util.zIndex.getLayerForElement(c),f=window.$sf.util.zIndex.maxForLayer(d)+1;c.css("z-index",f);if(e)return e(c)},b.destroyOnClose=b.destroyOnClose!==!1;var f=b.onClose;b.onClose=function(b,c){a(document).unbind("keydown.dialog");if(f)return f(b,c)}}}var g=this.sfDialog.apply(this,arguments);return g},b.bindingHandlers.dialog={init:function(c,d,e,f,g){function l(a,c,d){b.isObservable(a.isEnabled)&&a.isEnabled.subscribe(function(a){j.wsbDialog(a?"enableButton":"disableButton",c)})}var h=d(),i=!1,j=a(c),k={title:b.utils.unwrapObservable(h.title),modal:b.utils.unwrapObservable(h.isModal),autoOpen:b.utils.unwrapObservable(h.isOpen),zIndex:b.utils.unwrapObservable(h.zIndex),width:b.utils.unwrapObservable(h.width),autoResize:b.utils.unwrapObservable(h.autoResize),destroyOnClose:b.utils.unwrapObservable(h.destroyOnClose),buttons:b.utils.unwrapObservable(h.buttons),onOpen:function(){if(!i){i=!0;var a=g.createChildContext(f);b.applyBindingsToDescendants(a,c)}j.wsbDialog("resize"),h.open&&h.open()},onButtonClick:h.buttonClick,onCancel:h.cancel,onClose:function(){k.destroyOnClose&&(j=null),h.isOpen(!1)}};return j.wsbDialog(k),k.buttons&&k.buttons.forEach(l),h.isOpen.subscribe(function(b){b&&j===null&&(j=a(c).wsbDialog(k)),j!==null&&j.wsbDialog(b?"open":"close")}),b.isObservable(h.title)&&h.title.subscribe(function(a){j.wsbDialog({title:a})}),{controlsDescendantBindings:!0}}}})